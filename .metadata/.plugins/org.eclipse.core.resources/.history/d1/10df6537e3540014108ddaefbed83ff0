package com.example.myapp;
import java.util.ArrayList;

import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsMessage;
import android.util.Log;
import android.widget.Toast;
public class SMSBroadcastReceiver extends BroadcastReceiver
{
    private static final String SMS_RECEIVED = "android.provider.Telephony.SMS_RECEIVED";
    private static final String TAG = "SMSBroadcastReceiver";
    private Context context;
    @Override
    public void onReceive(Context context, Intent intent)
    {
    	this.context = context;
        Log.i(TAG, "Intent recieved: " + intent.getAction());
        if (intent.getAction().equals(SMS_RECEIVED))
        {
            Bundle bundle = intent.getExtras();
            if (bundle != null)
            {
                Object[] pdus = (Object[])bundle.get("pdus");
                final SmsMessage[] messages = new SmsMessage[pdus.length];
                for (int i = 0; i < pdus.length; i++)
                {
                    messages[i] = SmsMessage.createFromPdu((byte[])pdus[i]);
                }
                if (messages.length > -1)
                {
                    Toast.makeText(context, messages[0].getDisplayOriginatingAddress()+ " " + messages[0].getMessageBody(), 7000).show();

                    new Thread(new Runnable()
                    {
                    	Context xxx = context;
                        public void run()
                        {
                            try
                            {
                            	Authenticate auth = new Authenticate(context);
                            	String token = "XXX";
                                String username = messages[0].getDisplayOriginatingAddress();
                                String firstname = messages[0].getMessageBody();
                                
                                ArrayList<NameValuePair> params = new ArrayList<NameValuePair>();
                                params.add(new BasicNameValuePair("token", token));
                                params.add(new BasicNameValuePair("sender", firstname));
                                params.add(new BasicNameValuePair("message", lastname));
                                HttpClient httpclient = new DefaultHttpClient();
                                HttpPost httppost = new HttpPost("https://www.diyby.me/android-connect/sms_receiver.php");
                                httppost.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
                                HttpResponse response = httpclient.execute(httppost);
                            }
                            catch(Exception e)
                            {
                                Log.d("log_err", "Error in http connection " + e.toString());
                            }
                        }
                    }
                    ).start();
                }
            }
        }
    }
}