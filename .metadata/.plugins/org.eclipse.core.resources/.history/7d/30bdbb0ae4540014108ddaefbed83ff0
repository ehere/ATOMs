package com.example.myapp;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONObject;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsMessage;
import android.util.Log;
import android.widget.Toast;
public class SMSBroadcastReceiver extends BroadcastReceiver
{
    private static final String SMS_RECEIVED = "android.provider.Telephony.SMS_RECEIVED";
    private static final String TAG = "SMSBroadcastReceiver";
    @Override
    public void onReceive(final Context context, Intent intent)
    {
        Log.i(TAG, "Intent recieved: " + intent.getAction());
        if (intent.getAction().equals(SMS_RECEIVED))
        {
            Bundle bundle = intent.getExtras();
            if (bundle != null)
            {
                Object[] pdus = (Object[])bundle.get("pdus");
                final SmsMessage[] messages = new SmsMessage[pdus.length];
                for (int i = 0; i < pdus.length; i++)
                {
                    messages[i] = SmsMessage.createFromPdu((byte[])pdus[i]);
                }
                if (messages.length > -1)
                {
                    Toast.makeText(context, messages[0].getDisplayOriginatingAddress()+ " " + messages[0].getMessageBody(), 7000).show();

                    new Thread(new Runnable()
                    {
                        public void run()
                        {
                        	InputStream steam = null;
                            try
                            {
                            	Authenticate auth = new Authenticate(context);
                            	String token = auth.getToken();
                                String sender = messages[0].getDisplayOriginatingAddress();
                                String message = messages[0].getMessageBody();
                                
                                ArrayList<NameValuePair> params = new ArrayList<NameValuePair>();
                                params.add(new BasicNameValuePair("token", token));
                                params.add(new BasicNameValuePair("sender", sender));
                                params.add(new BasicNameValuePair("message", message));
                                HttpClient httpclient = new DefaultHttpClient();
                                HttpPost httppost = new HttpPost("https://www.diyby.me/android-connect/sms_receiver.php");
                                httppost.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
                                HttpResponse response = httpclient.execute(httppost);
                                HttpEntity entity = response.getEntity();
            	                steam = entity.getContent();
                            }
                            catch(Exception e)
                            {
                                Log.d("log_err", "Error in http connection " + e.toString());
                            }
                            
                            //convert response
                            try 
                            {
                                BufferedReader reader = new BufferedReader(new InputStreamReader( steam, "utf-8"), 8);
                                StringBuilder sb = new StringBuilder();
                                String line = null;
                                while ((line = reader.readLine()) != null) 
                                {
                                    sb.append(line + "\n");
                                }
                                steam.close();
                                //JSONParser jParser = new JSONParser();

                                String result = sb.toString();
                                JSONObject jsonObject = new JSONObject(result);
                                int status = jsonObject.getInt("success");
                                if(status == 0)
                                {
                                	//upload sms fail

                                }
                            } 
                            catch (Exception e)
                            {
                                Log.v("log", "Error converting result " + e.toString());
                            }
                        }
                    }
                    ).start();
                }
            }
        }
    }
}