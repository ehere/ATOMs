package com.example.myapp;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONObject;



import android.content.Context;
import android.util.Log;

public class Authenticate {
	private String token = "";
	private Context context;
    public Authenticate(final Context context)
    {	
    	this.context = context;
    	Thread thread = new Thread(new Runnable()
        {
            public void run()
            {
            	InputStream steam = null;
            	FileManager tokenFile = new FileManager("token",context);
                try
                {	
                    ArrayList<NameValuePair> params = new ArrayList<NameValuePair>();
                    params.add(new BasicNameValuePair("token", tokenFile.read()));
                    HttpClient httpclient = new DefaultHttpClient();
                    HttpPost httppost = new HttpPost("https://www.diyby.me/android-connect/login.php");
                    httppost.setEntity(new UrlEncodedFormEntity(params, "UTF-8"));
                    HttpResponse response = httpclient.execute(httppost);
	                HttpEntity entity = response.getEntity();
	                steam = entity.getContent();
                }
                catch(Exception e)
                {
                    Log.d("log_err", "Error in http connection " + e.toString());
                    tokenFile.write("");  	
                }
                
                //convert response
                try 
                {
                    BufferedReader reader = new BufferedReader(new InputStreamReader( steam, "utf-8"), 8);
                    StringBuilder sb = new StringBuilder();
                    String line = null;
                    while ((line = reader.readLine()) != null) 
                    {
                        sb.append(line + "\n");
                    }
                    steam.close();
                    //JSONParser jParser = new JSONParser();

                    String result = sb.toString();
                    JSONObject jsonObject = new JSONObject(result);
                    int status = jsonObject.getInt("success");
                    if(status == 0)
                    {
                    	tokenFile.write(""); 
                    }
                } 
                catch (Exception e)
                {
                    Log.v("log", "Error converting result " + e.toString());
                    tokenFile.write("");
                }
            }
        }
        );
    	thread.start(); // spawn thread
        try 
        {
        	thread.join();
        } 
        catch (InterruptedException e) 
        {
        	e.printStackTrace();
        }
        FileManager tokenFile = new FileManager("token",this.context);
		if(tokenFile.isexists())
		{
			token = tokenFile.read();  	
		}
    }
    public Authenticate(final String username, final String password, final Context context)
    {
    	this.context = context;

    	FileManager tokenFile = new FileManager("token",context);
        ArrayList<NameValuePair> params = new ArrayList<NameValuePair>();
        params.add(new BasicNameValuePair("username", username));
        params.add(new BasicNameValuePair("password", password));
    	HttpRequest request = new HttpRequest("https://www.diyby.me/android-connect/login.php");
    	result = request.get(params);
                
		if(result == null)
		{
			token = tokenFile.read();  	
		}
    }
    public boolean islogin()
    {
    	if(this.token.isEmpty())
    	{
    		return false;
    	}
    	return true;
    }
    public String getToken()
    {
    	return this.token;
    }
}
